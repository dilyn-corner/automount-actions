#!/bin/sh

. "$SNAP/bin/common"

init_mount_dir() {
    _arg_dir="$1"

}

watch_devices() {
    inotifywait --quiet --monitor --event "moved_to" --event "delete" /dev/disk/by-uuid | \
        while read -r _parent _action _uuid; do
            case "$_action" in
                MOVED_TO) try_mount "$_parent" "$_uuid" ;;
                DELETE)   rm_mount  "$_uuid" ;;
            esac
        done
}

try_mount() {
    _arg_parent="${1%/}"
    _arg_uuid="$2"

    _source="${_arg_parent}/${_arg_uuid}"
    _target="${_mount_dir}/${_arg_uuid}"

    log "$SNAP_NAME.auto-mount found: ${_source}"

    if ! mount "${_source}" "${_target}" >/dev/null 2>&1; then
        log "WARN: Could not mount ${_source} to ${_target}"
        return
    fi

    echo "${_target}" >> "${_watch_file}"
}

main() {
    set -eu

    # TODO: Should there be a $_log_dir env var in /bin/common?
    _date=$(date -Iseconds); readonly _date
    readonly _log_file="$SNAP_COMMON/logs/auto-mount/auto-mount_${_date}.log"
    readonly _mount_dir="/media/automount"

    init_log "$_log_file"
    init_watch_file
    init_mount_dir "$_mount_dir"

    watch_devices
}

main
