#!/bin/sh

. "$SNAP/bin/common"

watch_devices() {
    inotifywait --quiet --monitor --event "moved_to" --event "delete" /dev/disk/by-uuid | \
        while read -r _parent _action _uuid; do
            case "$_action" in
                MOVED_TO) try_mount "$_parent" "$_uuid" ;;
                DELETE)   rm -r "${_mount_dir}/${_uuid}" ;;
                *) : ;;
            esac
        done
}

try_mount() {
    _parent="${1%/}"
    _uuid="$2"

    _source="${_parent}/${_uuid}"
    _target="${_mount_dir}/${_uuid}"

    log "$SNAP_NAME.auto-mount found: ${_source}"

    mkdir -p "$_target"
    if ! mount "$_source" "$_target" >/dev/null 2>&1; then
        log "WARN: Could not mount ${_source} to ${_target}"
        return
    fi

    echo "$_target" >> "$WATCH_FILE"
}

main() {
    set -eu

    _log_file="$(mklog "${SNAP_COMMON}/logs")"; readonly _log_file
    readonly _mount_dir="${MOUNT_DIR:-"$(mktemp -d)"}"

    [ -p "$WATCH_FILE" ] || mkfifo "$WATCH_FILE"

    watch_devices
}

[ -n "$NOEXEC" ] || main
