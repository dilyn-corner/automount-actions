#!/bin/sh

. "$SNAP/bin/common"

watch_devices() {
    udisksctl monitor | awk -W interactive '/ Device:/ {print $2}'
}

automount() {
    _arg_device="$1"

    udisksctl mount --no-user-interaction --block-device "$_arg_device" | \
        cut -f4 -d' '
}

mount_devices() {
    while read -r -- _device; do

        [ -b "$_device" ] || continue

        log "$SNAP_NAME.auto-mount found ${_device}"

        # FIXME: Make sure the device contains a filesystem

        automount "$_device" >> "$_watch_file"
    done
}

main() {
    set -eu

    # TODO: why?
    sleep 5

    # TODO: Should there be a $_log_dir env var in /bin/common?
    _date=$(date -Iseconds); readonly _date
    readonly _log_file="$SNAP_COMMON/logs/auto-mount/auto-mount_${_date}.log"

    init_watch_file
    init_log "$_log_file"

    watch_devices | mount_devices
}

main
